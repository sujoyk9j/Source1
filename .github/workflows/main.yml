name: Deploy Source1 to Target1

on:
  push:
    branches:
      - main # Trigger on push to the 'main' branch of Source1

env:
  # ðŸ’¡ Change this to the folder containing your final build artifacts (e.g., build, out, public)
  ARTIFACT_PATH: dist 
  # ðŸ’¡ Change this to the branch you want to update in Target1
  TARGET_BRANCH: main 
  # The name of the target repo from your screenshot
  TARGET_REPO_NAME: Target1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source1 Repository
        uses: actions/checkout@v4
        with:
          # This step gets the code from Source1
          fetch-depth: 0 
          
      # ----------------------------------------------------
      - name: ðŸ› ï¸ Build & Test (Placeholder)
        run: |
          echo "Starting build process for Source1..."
          # Replace these lines with your actual build/test commands
          # e.g., npm ci, npm run build
          mkdir -p ${{ env.ARTIFACT_PATH }} # Creates a dummy 'dist' folder for testing
          echo "Hello from Source1" > ${{ env.ARTIFACT_PATH }}/index.html
          echo "Build complete. Artifacts are in '${{ env.ARTIFACT_PATH }}'."
          
      # ----------------------------------------------------
      - name: ðŸš€ Deploy to Target1
        run: |
# 1. Configure Git credentials
git config --global user.name "github-actions[bot]"
git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

# Authenticated URL
DEPLOY_URL="https://x-access-token:${{ secrets.GH_TOKEN }}@github.com/sujoyk9j/Target1.git"

# 2. Clone target repo
TEMP_DIR="/home/runner/work/_temp/target-clone"
git clone --single-branch --branch main ${DEPLOY_URL} ${TEMP_DIR} || \
(git clone ${DEPLOY_URL} ${TEMP_DIR})

# 3. Clean content but keep .git folder
find ${TEMP_DIR} -mindepth 1 ! -name ".git" -exec rm -rf {} +

# 4. Copy build artifacts
rsync -av --exclude='.git' dist/ ${TEMP_DIR}/

# 5. Commit & push
cd ${TEMP_DIR}
git add .

if git diff --cached --quiet; then
    echo "No changes detected. Skipping commit."
else
    git commit -m "CICD Deploy from Source1 (Run $GITHUB_RUN_NUMBER)"
    git push origin main
fi
